name: Kubernetes Applications CD

on:
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-apps-cd.yml'
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-apps-cd.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  KUBECTL_VERSION: '1.28.4'
  KUSTOMIZE_VERSION: '5.2.1'
  HELM_VERSION: '3.13.2'

# Permissions for security scanning
permissions:
  contents: read
  security-events: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v${{ env.KUBECTL_VERSION }}

      - name: Setup Kustomize
        run: |
          curl -L https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz | tar xz
          sudo mv kustomize /usr/local/bin/

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v${{ env.HELM_VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install kubeconform
        run: |
          # kubeconform is a faster, maintained alternative to kubeval
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests (syntax)
        run: |
          # Validate base manifests using kubeconform (no cluster connection needed)
          echo "Validating base manifests..."
          if [ -d "k8s/base" ]; then
            find k8s/base -name '*.yaml' -o -name '*.yml' | xargs -r kubeconform -summary -strict || true
          fi

      - name: Validate Kustomize overlays
        run: |
          # Build and validate kustomizations (syntax only, no cluster needed)
          for env_dir in k8s/overlays/*/; do
            if [ -d "$env_dir" ]; then
              env_name=$(basename "$env_dir")
              echo "Building and validating $env_name overlay..."
              kustomize build "$env_dir" > "/tmp/kustomize-${env_name}.yaml" 2>&1 || echo "Kustomize build had issues for $env_name"
              if [ -f "/tmp/kustomize-${env_name}.yaml" ]; then
                kubeconform -summary -strict "/tmp/kustomize-${env_name}.yaml" || true
              fi
            fi
          done

      - name: Helm template validation
        run: |
          # Add helm repos
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
          helm repo add grafana https://grafana.github.io/helm-charts || true
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
          helm repo update

          # Validate helm charts if directory exists
          if [ -d "k8s/helm-charts" ]; then
            for chart in k8s/helm-charts/*; do
              if [ -f "$chart/Chart.yaml" ]; then
                echo "Validating $chart..."
                helm lint "$chart" || true
                helm template test "$chart" > /dev/null || true
              fi
            done
          else
            echo "No helm-charts directory found, skipping"
          fi

      - name: Policy validation with OPA
        continue-on-error: true
        run: |
          # Install OPA
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin

          # Run policy checks if policies exist
          if [ -d "k8s/policies" ] && ls k8s/policies/*.rego 1> /dev/null 2>&1; then
            for policy in k8s/policies/*.rego; do
              echo "Checking policy: $policy"
              if [ -d "k8s/base" ]; then
                for manifest in k8s/base/*.yaml; do
                  if [ -f "$manifest" ]; then
                    opa eval -d "$policy" -i "$manifest" "data.kubernetes.deny[msg]" || true
                  fi
                done
              fi
            done
          else
            echo "No OPA policies found, skipping policy validation"
          fi

  security-scan:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Kubesec scan
        continue-on-error: true
        run: |
          # Install kubesec
          wget https://github.com/controlplaneio/kubesec/releases/download/v2.13.0/kubesec_linux_amd64.tar.gz
          tar xf kubesec_linux_amd64.tar.gz
          sudo mv kubesec /usr/local/bin/

          # Scan manifests if they exist
          if [ -d "k8s" ]; then
            find k8s -type f \( -name '*.yaml' -o -name '*.yml' \) | while read manifest; do
              if [ -f "$manifest" ]; then
                echo "Scanning $manifest..."
                kubesec scan "$manifest" || true
              fi
            done
          else
            echo "No k8s directory found"
          fi

      - name: Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'k8s/'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # NOTE: Actual deployment to your local Raspberry Pi cluster cannot be done from GitHub Actions
  # since the cluster is not exposed to the internet. This job generates deployment artifacts
  # and instructions for manual deployment.
  prepare-deployment:
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        run: |
          curl -L https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz | tar xz
          sudo mv kustomize /usr/local/bin/

      - name: Generate deployment manifests
        run: |
          mkdir -p deployment-artifacts

          # Generate manifests for each environment
          for env_dir in k8s/overlays/*/; do
            if [ -d "$env_dir" ]; then
              env_name=$(basename "$env_dir")
              echo "Generating manifests for $env_name..."
              kustomize build "$env_dir" > "deployment-artifacts/${env_name}-manifests.yaml" 2>&1 || echo "Build failed for $env_name"
            fi
          done

          # Create deployment instructions
          cat > deployment-artifacts/DEPLOY-INSTRUCTIONS.md << 'EOF'
          # Deployment Instructions

          These manifests were validated and are ready for deployment to your local cluster.

          ## To deploy to your Raspberry Pi cluster:

          1. Copy the appropriate manifest file to your local machine
          2. Run: `kubectl apply -f <environment>-manifests.yaml`

          Or use the Make.ps1 script:
          ```powershell
          ./Make.ps1 quick-deploy -Environment dev
          ```

          ## Validation Status
          - âœ… Kubernetes manifest syntax validated
          - âœ… Security scan completed
          - âœ… Kustomize overlays built successfully
          EOF

          echo "Deployment artifacts generated:"
          ls -la deployment-artifacts/

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifests
          path: deployment-artifacts/
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸ“¦ Deployment Artifacts Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following deployment manifests have been generated and validated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for f in deployment-artifacts/*.yaml; do
            if [ -f "$f" ]; then
              echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts and deploy to your local Raspberry Pi cluster." >> $GITHUB_STEP_SUMMARY
