name: Security Scanning

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Required permissions for security scanning and issue creation
permissions:
  contents: read
  security-events: write
  issues: write
  actions: read

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Snyk scan - only if supported manifest files exist
      - name: Check for Snyk-supported files
        id: check-manifests
        run: |
          # Check for various manifest files Snyk supports
          if [ -f "package.json" ] || [ -f "requirements.txt" ] || [ -f "Gemfile" ] || [ -f "pom.xml" ] || [ -f "go.mod" ]; then
            echo "has_manifest=true" >> $GITHUB_OUTPUT
          else
            echo "has_manifest=false" >> $GITHUB_OUTPUT
            echo "No Snyk-supported manifest files found in root. Skipping Snyk scan."
          fi

      - name: Run Snyk scan
        if: steps.check-manifests.outputs.has_manifest == 'true'
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Setup Ruby for Puppet
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: puppet

      - name: Bundle audit
        continue-on-error: true
        run: |
          cd puppet
          if [ -f "Gemfile" ]; then
            gem install bundler-audit --no-document
            bundle install --jobs 4 --retry 3 || true
            bundle audit check --update || echo "Bundle audit completed with findings"
          else
            echo "No Gemfile found, skipping bundle audit"
          fi

      - name: Python safety check
        continue-on-error: true
        run: |
          # Check if any requirements files exist
          if find . -name "requirements*.txt" -type f | head -1 | grep -q .; then
            pip install safety
            find . -name "requirements*.txt" -exec safety check -r {} \; || echo "Safety check completed with findings"
          else
            echo "No Python requirements files found, skipping safety check"
          fi

  container-scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - 'postgres:15'
          - 'minio/minio:latest'
          - 'grafana/grafana:latest'
          - 'prom/prometheus:latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanitize image name for filename
        id: sanitize
        run: |
          IMAGE="${{ matrix.image }}"
          # Replace / and : with - to create valid filename
          SAFE_NAME=$(echo "$IMAGE" | sed 's/[\/:]/-/g')
          echo "filename=trivy-results-${SAFE_NAME}.sarif" >> $GITHUB_OUTPUT
          echo "Sanitized filename: trivy-results-${SAFE_NAME}.sarif"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ matrix.image }}
          format: 'sarif'
          output: ${{ steps.sanitize.outputs.filename }}
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: ${{ steps.sanitize.outputs.filename }}
          category: container-${{ steps.sanitize.outputs.filename }}

  infrastructure-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkov Infrastructure Scan
        uses: bridgecrewio/checkov-action@master
        continue-on-error: true
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: checkov.sarif
          # Skip some checks that have false positives or are not applicable
          skip_check: CKV_DOCKER_2,CKV_DOCKER_3,CKV_SECRET_6,CKV_GHA_7,CKV2_GHA_1

      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: checkov.sarif

      - name: tfsec scan
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: true
        with:
          working_directory: terraform
          soft_fail: true

      - name: Run tfsec with SARIF output
        continue-on-error: true
        run: |
          # Install tfsec CLI for SARIF output
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec terraform --format sarif > tfsec.sarif 2>/dev/null || true

      - name: Upload tfsec results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always() && hashFiles('tfsec.sarif') != ''
        with:
          sarif_file: tfsec.sarif

  puppet-security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: puppet

      - name: Install and run puppet-lint security checks
        continue-on-error: true
        run: |
          cd puppet

          # Install dependencies based on whether Gemfile exists
          if [ -f "Gemfile" ]; then
            bundle install --jobs 4 --retry 3

            # Use bundle exec to respect repo binstubs
            if [ -d "site-modules" ]; then
              find site-modules -name '*.pp' -print0 | xargs -0 bundle exec puppet-lint \
                --with-context \
                --no-documentation-check \
                --no-140chars-check \
                || echo "Puppet-lint completed with findings"
            fi
          else
            # No Gemfile: install gem globally
            gem install puppet-lint puppet-lint-security-plugins --no-document

            if [ -d "site-modules" ]; then
              find site-modules -name '*.pp' -print0 | xargs -0 puppet-lint \
                --with-context \
                --no-documentation-check \
                --no-140chars-check \
                || echo "Puppet-lint completed with findings"
            fi
          fi

      - name: Metadata validation
        run: |
          cd puppet
          for module in site-modules/*/; do
            if [ -f "$module/metadata.json" ]; then
              echo "Validating $module metadata..."
              python3 -m json.tool "$module/metadata.json" > /dev/null || echo "Invalid JSON in $module"
            fi
          done

  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine scan refs
        id: refs
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE=""
            HEAD="${{ github.sha }}"
          fi

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "head=$HEAD" >> $GITHUB_OUTPUT

          if [ -n "$BASE" ] && [ "$BASE" != "$HEAD" ]; then
            echo "scan_type=diff" >> $GITHUB_OUTPUT
          else
            echo "scan_type=full" >> $GITHUB_OUTPUT
          fi

      - name: TruffleHog (diff scan)
        if: steps.refs.outputs.scan_type == 'diff'
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ steps.refs.outputs.base }}
          head: ${{ steps.refs.outputs.head }}
          extra_args: --only-verified

      - name: TruffleHog (full scan)
        if: steps.refs.outputs.scan_type == 'full'
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          extra_args: --only-verified

      - name: GitLeaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  compliance-check:
    runs-on: ubuntu-latest
    env:
      CHEF_LICENSE: "accept-no-persist"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for compliance profiles
        id: check-compliance
        run: |
          if [ -d "compliance" ] && ls compliance/*.rb 1> /dev/null 2>&1; then
            echo "has_profiles=true" >> $GITHUB_OUTPUT
          else
            echo "has_profiles=false" >> $GITHUB_OUTPUT
            echo "No InSpec compliance profiles found in compliance/ directory"
          fi

      - name: Run InSpec compliance tests
        if: steps.check-compliance.outputs.has_profiles == 'true'
        continue-on-error: true
        run: |
          # Install InSpec with license acceptance
          curl https://omnitruck.chef.io/install.sh | sudo CHEF_LICENSE=accept-no-persist bash -s -- -P inspec

          # Run compliance profiles
          inspec exec compliance/ --reporter json:compliance-results.json || echo "InSpec completed with findings"

      - name: Upload compliance results
        if: steps.check-compliance.outputs.has_profiles == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: compliance-results
          path: compliance-results.json
          if-no-files-found: ignore

  # Summary job that runs after all scans
  security-summary:
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, infrastructure-scan, puppet-security, secrets-scan, compliance-check]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Scan | ${{ needs.infrastructure-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Puppet Security | ${{ needs.puppet-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compliance Check | ${{ needs.compliance-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY

  create-issues:
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, infrastructure-scan, secrets-scan]
    if: failure()
    steps:
      - name: Create issue for failed scans
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security Scan Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `## Security Scan Results

                One or more security scans have failed or found issues. Please review the workflow results.

                **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

                **Scan Results:**
                - Dependency Scan: ${{ needs.dependency-scan.result }}
                - Container Scan: ${{ needs.container-scan.result }}
                - Infrastructure Scan: ${{ needs.infrastructure-scan.result }}
                - Secrets Scan: ${{ needs.secrets-scan.result }}

                **Action Items:**
                - [ ] Review security scan findings
                - [ ] Fix or document any vulnerabilities
                - [ ] Update dependencies if needed
                - [ ] Re-run security scans
                `,
                labels: ['security', 'automated']
              });
              console.log('Created issue #' + issue.data.number);
            } catch (error) {
              console.log('Could not create issue:', error.message);
            }
