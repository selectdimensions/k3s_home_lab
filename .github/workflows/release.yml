name: Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Required permissions for creating releases and pushing tags
permissions:
  contents: write
  packages: write

jobs:
  # Create tag only for workflow_dispatch (manual trigger)
  create-tag:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set version output
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "ERROR: Version input is empty"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          VERSION="${{ github.event.inputs.version }}"

          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping creation"
          else
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "Created and pushed tag: $VERSION"
          fi

  # Build artifacts - runs for both tag push and workflow_dispatch
  build-artifacts:
    runs-on: ubuntu-latest
    needs: [create-tag]
    if: always() && (github.event_name == 'push' || needs.create-tag.result == 'success')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # For tag push, extract version from ref
            if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
              VERSION="${GITHUB_REF#refs/tags/}"
            else
              echo "ERROR: GITHUB_REF is not a tag (GITHUB_REF=${GITHUB_REF})"
              exit 1
            fi
          else
            # For workflow_dispatch, use the input
            VERSION="${{ github.event.inputs.version }}"
          fi

          if [ -z "$VERSION" ]; then
            echo "ERROR: Version is empty. Provide a tag or version input."
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Resolved version: $VERSION"

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.14.0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        continue-on-error: true
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          platforms: linux/amd64,linux/arm64

      - name: Create Helm packages
        run: |
          mkdir -p artifacts/helm

          # Package any Helm charts if they exist
          if [ -d "k8s/helm-charts" ]; then
            for chart in k8s/helm-charts/*; do
              if [ -f "$chart/Chart.yaml" ]; then
                echo "Packaging $chart..."
                helm package "$chart" -d artifacts/helm || echo "Failed to package $chart"
              fi
            done
          else
            echo "No helm-charts directory found"
          fi

      - name: Create deployment package
        run: |
          mkdir -p artifacts/deployment
          VERSION="${{ steps.version.outputs.version }}"

          # Create a deployment package with all necessary files
          tar -czf "artifacts/deployment/k3s-homelab-${VERSION}.tar.gz" \
            --exclude='.git' \
            --exclude='artifacts' \
            --exclude='node_modules' \
            --exclude='.terraform' \
            --exclude='vendor' \
            --exclude='*.log' \
            . || echo "Tar completed with warnings"

          echo "Created deployment package:"
          ls -lh artifacts/deployment/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ steps.version.outputs.version }}
          path: artifacts/
          retention-days: 90

  # Security scan
  security-scan:
    runs-on: ubuntu-latest
    needs: [build-artifacts]
    if: needs.build-artifacts.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'

      - name: Container security scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-artifacts.outputs.version }}
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # Create GitHub Release with artifacts
  create-github-release:
    runs-on: ubuntu-latest
    needs: [build-artifacts, security-scan]
    if: always() && needs.build-artifacts.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.build-artifacts.outputs.version }}
          path: artifacts/

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.build-artifacts.outputs.version }}"

          # Generate changelog from git commits
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${VERSION}$" | head -1 || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "${PREVIOUS_TAG}..HEAD" 2>/dev/null || echo "- Initial release")
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" -20 2>/dev/null || echo "- Initial release")
          fi

          # Save changelog to file
          cat > CHANGELOG.md << EOF
          ## What's Changed

          ${CHANGELOG}

          ## Infrastructure Components

          - **Kubernetes**: K3s cluster with 4 Raspberry Pi nodes
          - **Data Platform**: Apache NiFi, Trino, MinIO
          - **Monitoring**: Prometheus, Grafana
          - **Configuration Management**: Puppet
          - **Infrastructure as Code**: Terraform

          ## Deployment Guide

          1. Download the deployment package: \`k3s-homelab-${VERSION}.tar.gz\`
          2. Extract: \`tar -xzf k3s-homelab-${VERSION}.tar.gz\`
          3. Follow the setup instructions in README.md
          4. Run: \`./Make.ps1 quick-deploy -Environment dev\`

          ## Security Notes

          - All container images have been scanned for vulnerabilities
          - Secrets should be updated according to security guidelines
          - Network policies are enforced for container isolation
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-artifacts.outputs.version }}
          name: Pi K3s Home Lab ${{ needs.build-artifacts.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(needs.build-artifacts.outputs.version, 'rc') || contains(needs.build-artifacts.outputs.version, 'beta') || contains(needs.build-artifacts.outputs.version, 'alpha') }}
          files: |
            artifacts/deployment/*.tar.gz
            artifacts/helm/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary and notification
  notify:
    runs-on: ubuntu-latest
    needs: [build-artifacts, create-github-release]
    if: always()
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ needs.build-artifacts.outputs.version }}"
          RELEASE_STATUS="${{ needs.create-github-release.result }}"

          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION:-'N/A'} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Status | ${RELEASE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$RELEASE_STATUS" = "success" ]; then
            echo "âœ… Release created successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the release artifacts from the [Releases page](../../releases)" >> $GITHUB_STEP_SUMMARY
            echo "2. Deploy to your Raspberry Pi cluster using \`./Make.ps1 quick-deploy\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release had issues. Check the workflow logs." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack notification
        if: vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.create-github-release.result }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ðŸš€ Pi K3s Home Lab Release: ${{ needs.build-artifacts.outputs.version }}
            Status: ${{ needs.create-github-release.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
