name: üöÄ Complete Infrastructure Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: 'Skip validation tests'
        required: false
        default: false
        type: boolean
      deploy_data_platform:
        description: 'Include data platform in deployment package'
        required: true
        default: true
        type: boolean

# Required permissions for SARIF upload and artifact management
permissions:
  contents: read
  security-events: write
  actions: read

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  # Use 1.5.7 to avoid DAG walker panic in 1.6.0
  TERRAFORM_VERSION: '1.5.7'

# NOTE: This workflow VALIDATES and PACKAGES infrastructure.
# Actual deployment to your local Pi cluster happens via Make.ps1 on your machine.
# GitHub Actions cannot reach your local network.

jobs:
  # Pre-flight checks
  preflight:
    name: üîç Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.checks.outputs.should_deploy }}
      terraform_path: ${{ steps.checks.outputs.terraform_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment
        id: checks
        run: |
          echo "üîç Validating environment: $ENVIRONMENT"

          # Check if Terraform environment exists
          TERRAFORM_PATH="terraform/environments/$ENVIRONMENT"
          if [ ! -d "$TERRAFORM_PATH" ]; then
            echo "‚ùå Terraform environment not found: $TERRAFORM_PATH"
            exit 1
          fi

          echo "‚úÖ Terraform environment found: $TERRAFORM_PATH"
          echo "terraform_path=$TERRAFORM_PATH" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Check inventory configuration
        run: |
          if [ ! -f "inventory.yaml.example" ]; then
            echo "‚ö†Ô∏è inventory.yaml.example not found (optional)"
          else
            echo "‚úÖ Inventory example found"
          fi

  # Security and validation
  security_scan:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    needs: preflight
    if: github.event.inputs.skip_tests == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  # Terraform validation and planning
  terraform_validate:
    name: üèóÔ∏è Terraform Validation
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: |
          cd ${{ needs.preflight.outputs.terraform_path }}
          terraform fmt -check -recursive || echo "Format issues found"
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd ${{ needs.preflight.outputs.terraform_path }}
          terraform init -backend=false -input=false

      - name: Create validation tfvars
        run: |
          cd ${{ needs.preflight.outputs.terraform_path }}
          # Create minimal tfvars for validation (not real secrets)
          # Note: terraform validate doesn't use tfvars, but plan does
          cat > terraform.tfvars << 'EOF'
          grafana_admin_password = "validation-only"
          postgres_password = "validation-only"
          minio_secret_key = "validation-only"
          nifi_admin_password = "validation-only"
          trino_admin_password = "validation-only"
          vault_token = "validation-only"
          backup_storage_location = "/tmp/backups"
          EOF

      - name: Terraform Validate
        run: |
          cd ${{ needs.preflight.outputs.terraform_path }}
          terraform validate

      - name: Terraform Plan (Validation)
        run: |
          cd ${{ needs.preflight.outputs.terraform_path }}
          # Use parallelism=1 to avoid DAG walker issues
          terraform plan -input=false -parallelism=1 2>&1 || echo "Plan completed (some errors expected without live cluster)"
        continue-on-error: true

  # Puppet validation
  puppet_validate:
    name: üé≠ Puppet Validation
    runs-on: ubuntu-latest
    needs: preflight
    if: github.event.inputs.skip_tests == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: puppet

      - name: Install dependencies via Bundler
        run: |
          cd puppet
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs=4 --retry=3

      - name: Puppet Lint
        run: |
          cd puppet
          if [ -d "site-modules" ]; then
            find site-modules -name "*.pp" -exec bundle exec puppet-lint \
              --no-documentation-check \
              --no-140chars-check \
              {} \; || echo "Lint issues found"
          fi
        continue-on-error: true

      - name: Puppet Parser Validation
        run: |
          cd puppet
          if [ -d "site-modules" ]; then
            find site-modules -name "*.pp" -print0 | xargs -0 -I {} bundle exec puppet parser validate {} || echo "Parser issues found"
          fi
        continue-on-error: true

      - name: Puppet RSpec Tests
        run: |
          cd puppet
          if [ -f "Gemfile" ] && [ -d "spec" ]; then
            bundle exec rspec spec/ || echo "Some tests failed"
          else
            echo "No spec directory or Gemfile found, skipping RSpec tests"
          fi
        continue-on-error: true

      - name: Validate Bolt Project
        run: |
          cd puppet
          gem install bolt --no-document
          bolt project show 2>/dev/null || echo "Bolt project validation skipped"
        continue-on-error: true

  # Kubernetes manifest validation
  k8s_validate:
    name: ‚ò∏Ô∏è Kubernetes Validation
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Install kubeconform
        run: |
          curl -sL "https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz" | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          if [ -d "k8s" ]; then
            find k8s -name '*.yaml' -o -name '*.yml' | xargs -r kubeconform \
              -strict \
              -ignore-missing-schemas \
              -kubernetes-version 1.29.0 \
              -summary || echo "Some validation issues found"
          fi
        continue-on-error: true

      - name: Validate Helm values
        run: |
          if [ -d "k8s/helm-values" ]; then
            for values in k8s/helm-values/*.yaml; do
              if [ -f "$values" ]; then
                echo "Validating $values..."
                python3 -c "import yaml; yaml.safe_load(open('$values'))" || echo "Invalid: $values"
              fi
            done
          fi
        continue-on-error: true

  # Create deployment package
  create_deployment_package:
    name: üì¶ Create Deployment Package
    runs-on: ubuntu-latest
    needs: [preflight, terraform_validate, puppet_validate, k8s_validate, security_scan]
    if: always() && needs.terraform_validate.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Create deployment package
        run: |
          mkdir -p deployment-package

          # Copy infrastructure code
          cp -r terraform deployment-package/
          cp -r puppet deployment-package/
          cp -r k8s deployment-package/ 2>/dev/null || true
          cp -r scripts deployment-package/ 2>/dev/null || true
          cp Make.ps1 deployment-package/ 2>/dev/null || true
          cp Makefile deployment-package/ 2>/dev/null || true
          cp inventory.yaml.example deployment-package/ 2>/dev/null || true

          # Remove .terraform directories and state files
          find deployment-package -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
          find deployment-package -name "*.tfstate*" -type f -delete 2>/dev/null || true
          find deployment-package -name "vendor" -type d -exec rm -rf {} + 2>/dev/null || true

          # Create deployment instructions
          cat > deployment-package/DEPLOY.md << 'EOF'
          # üöÄ Deployment Instructions for Pi K3s Cluster

          This package contains validated infrastructure code for your Raspberry Pi K3s cluster.

          ## Prerequisites

          - SSH access to Pi nodes (192.168.0.120-123)
          - PowerShell 7+ (for Make.ps1)
          - Terraform 1.5.7+
          - kubectl configured

          ## Quick Start

          ### 1. Configure Secrets

          Create `terraform/environments/$ENVIRONMENT/terraform.tfvars`:
          ```hcl
          postgres_password    = "your-secure-password"
          minio_secret_key     = "your-secure-key"
          nifi_admin_password  = "your-secure-password"
          trino_admin_password = "your-secure-password"
          grafana_admin_password = "your-secure-password"
          vault_token          = "your-vault-token"
          ```

          ### 2. Deploy with Make.ps1

          ```powershell
          # Initialize Terraform
          ./Make.ps1 terraform-init -Environment dev

          # Plan changes
          ./Make.ps1 terraform-plan -Environment dev

          # Apply changes
          ./Make.ps1 terraform-apply -Environment dev

          # Deploy with Puppet
          ./Make.ps1 puppet-deploy

          # Check cluster status
          ./Make.ps1 cluster-status
          ```

          ### 3. Access Services

          ```powershell
          # Open NiFi UI
          ./Make.ps1 nifi-ui

          # Open Grafana UI
          ./Make.ps1 grafana-ui
          ```

          ## Environment: ${{ env.ENVIRONMENT }}

          - **Build:** ${{ github.sha }}
          - **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Data Platform:** ${{ github.event.inputs.deploy_data_platform }}

          EOF

          # Add version info
          echo "commit: ${{ github.sha }}" > deployment-package/VERSION
          echo "environment: ${{ env.ENVIRONMENT }}" >> deployment-package/VERSION
          echo "date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deployment-package/VERSION
          echo "data_platform: ${{ github.event.inputs.deploy_data_platform }}" >> deployment-package/VERSION

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ env.ENVIRONMENT }}-${{ github.sha }}
          path: deployment-package/
          retention-days: 30

      - name: Generate deployment summary
        run: |
          echo "## üöÄ Deployment Package Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Data Platform:** ${{ github.event.inputs.deploy_data_platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download & Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`deployment-package-${{ env.ENVIRONMENT }}-${{ github.sha }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract to your workspace" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure secrets in \`terraform.tfvars\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Run: \`./Make.ps1 quick-deploy -Environment ${{ env.ENVIRONMENT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform_validate.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Puppet | ${{ needs.puppet_validate.result == 'success' && '‚úÖ Passed' || needs.puppet_validate.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | ${{ needs.k8s_validate.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security_scan.result == 'success' && '‚úÖ Passed' || needs.security_scan.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** This is a local Pi cluster. Deploy using Make.ps1 on your local machine." >> $GITHUB_STEP_SUMMARY

  # Validation summary
  validate_success:
    name: ‚úÖ Validation Summary
    runs-on: ubuntu-latest
    needs: [preflight, terraform_validate, puppet_validate, k8s_validate, security_scan, create_deployment_package]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform_validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Puppet | ${{ needs.puppet_validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | ${{ needs.k8s_validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security_scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package | ${{ needs.create_deployment_package.result }} |" >> $GITHUB_STEP_SUMMARY

          # Check for critical failures
          if [[ "${{ needs.preflight.result }}" == "failure" ]]; then
            echo "‚ùå Pre-flight checks failed"
            exit 1
          fi

          if [[ "${{ needs.terraform_validate.result }}" == "failure" ]]; then
            echo "‚ùå Terraform validation failed"
            exit 1
          fi

          echo ""
          echo "‚úÖ Core validations passed. Deployment package is ready."

  # Notification
  notify:
    name: üì¢ Notify Results
    runs-on: ubuntu-latest
    needs: [validate_success, create_deployment_package]
    if: always() && vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
    steps:
      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.validate_success.result == 'success' && 'success' || 'failure' }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Infrastructure Setup: ${{ needs.validate_success.result == 'success' && '‚úÖ Ready for deployment' || '‚ùå Validation failed' }}
            Environment: ${{ env.ENVIRONMENT }}
            Download the deployment package from the workflow artifacts.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
