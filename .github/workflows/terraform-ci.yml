name: Terraform CI/CD

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-ci.yml'
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-ci.yml'

env:
  TF_VERSION: '1.6.0'
  TFLINT_VERSION: 'v0.48.0'
  TERRAFORM_DOCS_VERSION: 'v0.16.0'

# Note: This is a home lab Pi cluster. GitHub Actions validates only.
# Actual deployment happens locally via Make.ps1

jobs:
  validate:
    name: Validate ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
      fail-fast: false
    outputs:
      dev_status: ${{ steps.validate.outputs.dev_status }}
      staging_status: ${{ steps.validate.outputs.staging_status }}
      prod_status: ${{ steps.validate.outputs.prod_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive terraform/
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init
        working-directory: terraform

      - name: Run TFLint
        id: lint
        run: tflint --recursive
        working-directory: terraform
        continue-on-error: true

      - name: Terraform Init
        id: init
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          terraform validate
          echo "${{ matrix.environment }}_status=success" >> $GITHUB_OUTPUT

      - name: Set validation status
        if: failure()
        run: echo "${{ matrix.environment }}_status=failed" >> $GITHUB_OUTPUT

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: tfsec scan
        uses: aquasecurity/tfsec-action@v1.0.3
        continue-on-error: true
        with:
          working_directory: terraform
          soft_fail: true

      - name: Checkov scan
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: terraform
          framework: terraform
          quiet: true

  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform Docs
        uses: terraform-docs/gh-actions@v1.3.0
        with:
          working-dir: terraform/modules/k3s-cluster,terraform/modules/puppet-infrastructure,terraform/modules/data-platform,terraform/modules/monitoring,terraform/modules/security,terraform/modules/backup
          output-file: README.md
          output-method: inject
          git-push: "false"  # Don't auto-push - create artifact instead

      - name: Upload generated docs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-docs
          path: terraform/modules/**/README.md
          retention-days: 30

  plan-preview:
    name: Plan Preview ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        environment: [dev, staging, prod]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Create dummy tfvars for plan
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          # Create minimal tfvars for validation (sensitive values are dummies)
          if [ ! -f terraform.tfvars ]; then
            echo 'postgres_password = "validation-only"' > terraform.tfvars
            echo 'minio_secret_key = "validation-only"' >> terraform.tfvars
            echo 'nifi_admin_password = "validation-only"' >> terraform.tfvars
            echo 'trino_admin_password = "validation-only"' >> terraform.tfvars
            echo 'grafana_admin_password = "validation-only"' >> terraform.tfvars
            echo 'vault_token = "validation-only"' >> terraform.tfvars
          fi

      - name: Terraform Plan (Validation Only)
        id: plan
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          # Plan without real credentials - validates structure only
          terraform plan -no-color -input=false 2>&1 | tee plan.txt || true
          # Extract summary for PR comment
          echo "### Terraform Plan Summary - ${{ matrix.environment }}" > plan-summary.txt
          echo "" >> plan-summary.txt
          if grep -q "No changes" plan.txt; then
            echo "‚úÖ No infrastructure changes required" >> plan-summary.txt
          elif grep -q "Error" plan.txt; then
            echo "‚ö†Ô∏è Plan completed with warnings (expected for validation without live cluster)" >> plan-summary.txt
          else
            echo "üìã Plan generated - review required for local deployment" >> plan-summary.txt
          fi
        continue-on-error: true

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let summary = '‚ö†Ô∏è Plan validation completed';
            try {
              summary = fs.readFileSync('terraform/environments/${{ matrix.environment }}/plan-summary.txt', 'utf8');
            } catch (e) {
              console.log('No summary file found');
            }

            const output = `#### Terraform Validation - ${{ matrix.environment }} üìã

            ${summary}

            > **Note:** This is a local Pi cluster. Actual deployment happens via \`Make.ps1\` on your local machine.
            > Run: \`./Make.ps1 terraform-plan -Environment ${{ matrix.environment }}\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  prepare-deployment:
    name: Prepare Deployment Package
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create deployment package
        run: |
          mkdir -p deployment-package

          # Copy Terraform files
          cp -r terraform deployment-package/

          # Remove .terraform directories and state files
          find deployment-package -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
          find deployment-package -name "*.tfstate*" -type f -delete 2>/dev/null || true

          # Create deployment instructions
          cat > deployment-package/DEPLOY.md << 'EOF'
          # Terraform Deployment Instructions

          This package contains validated Terraform configurations for the Pi K3s cluster.

          ## Prerequisites
          - SSH access to Pi nodes (192.168.0.120-123)
          - Kubeconfig for the cluster
          - Required secrets configured

          ## Deployment Steps

          ### Option 1: Using Make.ps1 (Recommended)
          ```powershell
          # Initialize
          ./Make.ps1 terraform-init -Environment dev

          # Plan
          ./Make.ps1 terraform-plan -Environment dev

          # Apply
          ./Make.ps1 terraform-apply -Environment dev
          ```

          ### Option 2: Manual Terraform
          ```bash
          cd terraform/environments/dev
          terraform init
          terraform plan -var-file=terraform.tfvars
          terraform apply -var-file=terraform.tfvars
          ```

          ## Environments
          - **dev**: Development/testing configuration
          - **staging**: Pre-production testing
          - **prod**: Full production deployment

          ## Secrets Required
          Set these in your terraform.tfvars:
          - postgres_password
          - minio_secret_key
          - nifi_admin_password
          - trino_admin_password
          - grafana_admin_password
          - vault_token
          EOF

          # Add version info
          echo "Built from: ${{ github.sha }}" > deployment-package/VERSION
          echo "Build date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deployment-package/VERSION

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: terraform-deployment-${{ github.sha }}
          path: deployment-package/
          retention-days: 30

      - name: Create deployment summary
        run: |
          echo "## üöÄ Terraform Deployment Package Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A deployment package has been created for the Pi K3s cluster." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download & Deploy" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`terraform-deployment-${{ github.sha }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract to your workspace" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: \`./Make.ps1 terraform-apply -Environment dev\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validated Environments" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ dev" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ staging" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ prod" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate, security-scan, prepare-deployment]
    if: always() && vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
    steps:
      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.validate.result == 'success' && needs.security-scan.result != 'failure' && 'success' || 'failure' }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Terraform CI/CD: ${{ needs.validate.result == 'success' && '‚úÖ Validation passed' || '‚ùå Validation failed' }}
            Security Scan: ${{ needs.security-scan.result != 'failure' && '‚úÖ Passed' || '‚ö†Ô∏è Issues found' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
